name: SecurePR Security Scanner

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Required for posting PR comments
permissions:
  contents: read
  pull-requests: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Display PR info
        run: |
          echo "::group::üìã Pull Request Info"
          echo "==========================================="
          echo "üî¢ PR #${{ github.event.pull_request.number }}"
          echo "üìù ${{ github.event.pull_request.title }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo "üîÄ ${{ github.base_ref }} ‚Üê ${{ github.head_ref }}"
          echo "==========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Draft: ${{ github.event.pull_request.draft }}"
          echo "::endgroup::"

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "::group::üì¶ Installing Dependencies"
          pip install openai PyGithub
          echo "::endgroup::"

      - name: Show PR commits
        run: |
          echo "::group::üí¨ PR Commits"
          git log --oneline ${{ github.base_ref }}..${{ github.event.pull_request.head.sha }} | head -20
          echo "::endgroup::"

      - name: List changed files
        id: changed-files
        run: |
          echo "::group::üìÅ Changed Files"
          FILES=$(git diff --name-only ${{ github.base_ref }}...${{ github.event.pull_request.head.sha }} 2>/dev/null || true)
          if [ -z "$FILES" ]; then
            echo "No files changed in this PR."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            COUNT=$(echo "$FILES" | wc -l | tr -d ' ')
            echo "Total files changed: $COUNT"
            echo "---"
            echo "$FILES" | while read file; do
              if [ -n "$file" ]; then
                echo "‚Ä¢ $file"
              fi
            done
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Run security analysis
        id: security-scan
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "::group::üîí Security Analysis"
          echo "==========================================="
          echo "   SecurePR Security Scanner"
          echo "   PR #${{ github.event.pull_request.number }}"
          echo "==========================================="
          
          # Debug: Check if API key is being passed
          echo "üîë Checking API key..."
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "‚úÖ API key is set (starts with: ${OPENAI_API_KEY:0:8}...)"
          else
            echo "‚ùå API key is NOT set"
            echo ""
            echo "::error::OPENAI_API_KEY secret is not set!"
            echo ""
            echo "Troubleshooting:"
            echo "1. Go to: Settings > Secrets and variables > Actions"
            echo "2. Add a new repository secret named: OPENAI_API_KEY"
            echo "3. Paste your OpenAI API key as the value"
            echo ""
            echo "Note: For PRs from forks, secrets are NOT available (GitHub security policy)."
            echo "If this is a fork PR, the maintainer needs to run the workflow manually."
            exit 1
          fi
          
          # Get the diff between base and head
          DIFF=$(git diff ${{ github.base_ref }}...${{ github.event.pull_request.head.sha }} 2>/dev/null)
          
          if [ -z "$DIFF" ]; then
            echo "No diff content to analyze."
            echo "::endgroup::"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Analyzing $(echo "$DIFF" | wc -l | tr -d ' ') lines of changes..."
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }} (${{ github.event.pull_request.head.sha }})"
          echo ""
          
          # Run the security analysis script and capture output
          echo "$DIFF" | python scripts/analyze_security.py > /tmp/security_results.md 2>&1
          RESULT=$?
          
          cat /tmp/security_results.md
          
          # Parse status from output
          STATUS=$(grep "^STATUS=" /tmp/security_results.md | cut -d= -f2 || echo "UNKNOWN")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
          
          if [ $RESULT -ne 0 ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        id: post-comment
        if: steps.changed-files.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::üí¨ Posting PR Comment"
          
          VULN_FLAG=""
          if [ "${{ steps.security-scan.outputs.has_vulnerabilities }}" == "true" ]; then
            VULN_FLAG="--has-vulnerabilities"
          fi
          
          python scripts/post_pr_comment.py \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --content-file /tmp/security_results.md \
            $VULN_FLAG
          
          echo "::endgroup::"

      - name: Comment fallback notice
        if: steps.post-comment.outcome == 'failure'
        run: |
          echo "::warning::Unable to post comment (likely a fork PR). Results shown in logs above."
          echo ""
          echo "üìã Security analysis results are available in the 'Run security analysis' step above."

      - name: Security status summary
        if: always()
        run: |
          echo ""
          echo "==========================================="
          echo "   üîí SECURITY SCAN STATUS"
          echo "==========================================="
          
          STATUS="${{ steps.security-scan.outputs.status }}"
          
          if [ "$STATUS" == "FAIL" ]; then
            echo "‚ùå FAILED - Critical/High severity issues found"
            echo ""
            echo "This PR cannot be merged until security issues are resolved."
          elif [ "$STATUS" == "WARN" ]; then
            echo "‚ö†Ô∏è WARNING - Medium/Low severity issues found"
            echo ""
            echo "Review recommended but PR can be merged."
          elif [ "$STATUS" == "PASS" ]; then
            echo "‚úÖ PASSED - No security issues detected"
            echo ""
            echo "This PR is safe to merge from a security perspective."
          elif [ "${{ steps.changed-files.outputs.has_changes }}" != "true" ]; then
            echo "‚è≠Ô∏è SKIPPED - No files changed"
          else
            echo "‚ùì UNKNOWN - Status could not be determined"
          fi
          
          echo "==========================================="
          echo ""
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"

      - name: Fail if critical vulnerabilities
        if: steps.security-scan.outputs.has_vulnerabilities == 'true'
        run: |
          echo "::error::Security vulnerabilities detected in PR #${{ github.event.pull_request.number }}!"
          echo "Please review the findings in the PR comment before merging."
          exit 1
